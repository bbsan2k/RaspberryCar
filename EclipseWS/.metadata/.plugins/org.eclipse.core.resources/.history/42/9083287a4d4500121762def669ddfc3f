import web
from multiprocessing import Process
from web import form
import DriveHandler
from SimpleXMLRPCServer import SimpleXMLRPCServer as Server

## Drivehandler

handler = DriveHandler.driveHandler()

## SimpleXMLRPCServer Part
rpcSrv = Server(("",1337))

def drive(direction):
    handler.drive(direction)

def setUpRpc():
    rpcSrv.register_function(drive)
    print("RPC up and running")
    rpcSrv.serve_forever()

def setUpWeb():
    app.run
## Web.py Part
urls = (
    '/', 'index',
    '/command/(.*)', 'command'
)
app = web.application(urls, globals())
render = web.template.render('templates/')

driveForm = form.Form(
                      form.Button(type="submit", name = "button", html="Forward", value="fwd"),
                      form.Button(type="submit", name = "button", html="Right", value="rgt"),
                      form.Button(type="submit", name = "button", html="Left", value="lft"),
                      form.Button(type="submit", name = "button", html ="Stop", value="stp")

)

class index:        
    def GET(self):
        form = driveForm()
        return render.formtest(driveForm)
    def POST(self):
        i = web.input()
        if (i.button == "fwd"):
            handler.drive("fwd")
        elif (i.button == "rgt"):
            handler.drive("right")
        elif (i.button == "lft"):
            handler.drive("left")
        elif (i.button == "stp"):
            handler.drive("stop")
        return render.formtest(driveForm)
        
class command:
    def GET(self, key):
        handler.drive(key)
        return 'Got command: %s' % key 

if __name__ == "__main__":
    
    p1 = Process(target=setUpWeb, args=())
    p2 = Process(target=setUpRpc, args=())
    p1.start()
    p2.start()
    p1.join()
    p2.join()
    ##setUpRpc()
    ##app.run()




